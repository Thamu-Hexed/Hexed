<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hexed Party Boss Blitz Roster</title>
  <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    /* Root variables for theming */
    :root {
      /* Dark theme colors */
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #252525;
      --accent-primary: #3d84f7;
      --accent-secondary: #ed4b9e;
      --accent-tertiary: #f2c94c;
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-tertiary: #b0b0b0;
      --guild-color: #4ade80;
      --merc-color: #c084fc;
      --border-light: rgba(255, 255, 255, 0.1);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
      --grid-gap: 1.7rem;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 8px;
      --filled-glow: #e6973b;
    }
    
    /* Reset and base styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Body styles */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(61, 132, 247, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(237, 75, 158, 0.05) 0%, transparent 20%);
    }

    /* Header styles */
    header {
      background-color: var(--bg-secondary);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid var(--border-light);
    }

    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      padding-left: 0px; /* Make space for icon */
      cursor: pointer; /* Shows it's clickable */
      transition: transform 0.2s ease; /* Optional: Add hover effect */
    }

    .header-title:hover {
      text-shadow: 0 0 15px rgba(61, 132, 247, 0.8); /* Optional: Glow effect */
    }
    
    .header-title::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      background-size: contain;
      background-repeat: no-repeat;
      filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
      cursor: pointer; /* Makes header icon clickable */
    }
    
    /* Main container styles */
    .container {
      position: relative;
      z-index: 50;
      max-width: calc(1200px);
      margin: 2rem auto;
      padding: 2rem;
      background-color: rgba(30, 30, 30, 0.7);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    /* Responsive container */
    @media (max-width: 1200px) {
      .container {
        max-width: 1200px;
      }
    }

    /* Dragging state */
    .dragging {
      opacity: 0.6;
      background-color: var(--bg-tertiary);
    }

    /* Heading styles */
    h1 {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    /* Description text */
    .description {
      text-align: center;
      max-width: 700px;
      margin: 0 auto 2rem;
      font-size: 1.1rem;
      color: var(--text-secondary);
      line-height: 1.7;
      padding: 1rem;
      background-color: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }
    
    /* Player type indicators */
    .player-guild {
      color: var(--guild-color);
      font-weight: 500;
    }
    
    .player-merc {
      color: var(--merc-color);
      font-weight: 500;
    }
    
    /* Navigation styles */
    nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    nav button {
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.2s ease-in-out;
      font-size: 1rem;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    nav button svg {
      width: 16px;
      height: 16px;
    }

    nav button.active {
      transform: translateY(0);
      box-shadow: none;
      outline: 2px solid rgba(255, 255, 255, 0.8);
    }

    nav button:hover:not(.active) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      filter: brightness(1.1);
    }
    
    /* Admin panel button */
    .admin-panel-btn {
      background-color: var(--accent-secondary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Poppins', sans-serif;
      box-shadow: var(--shadow-sm);
    }
    
    .admin-panel-btn:hover {
      background-color: #d43d8a;
      box-shadow: 0 0 10px rgba(237, 75, 158, 0.5);
      transform: translateY(-1px);
    }
    
    nav button svg {
      width: 16px;
      height: 16px;
    }
    
    /* Mode buttons */
    #btn-normal { 
      background-color: #357fda;
    }

    #btn-normal.active {
      background-color: #3d84f7;
      outline: 2px solid rgba(0, 182, 255, 1);
    }

    #btn-hard { 
      background-color: #c62d3c;
    }

    #btn-hard.active {
      background-color: #D63141;
      outline: 2px solid rgba(255, 132, 0, 1);
    }
    
    #btn-rerun { 
      background-color: #e251a3;
      color: white;
    }

    #btn-rerun.active {
      background-color: #ed4b9e;
      outline: 2px solid rgba(255, 148, 178, 1);
    }
    
    /* Time notice */
    .time-notice {
      text-align: center;
      margin: 0 auto 2rem;
      font-size: 0.95rem;
      color: #a0c4fe;
      font-style: italic;
      opacity: 0.8;
    }
    
    /* Roster grid layout */
    .roster {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--grid-gap);
    }
    
    /* Group styling */
    .group {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 1.5rem;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      border: 1px solid var(--border-light);
      position: relative;
      overflow: hidden;
    }
    
    .group::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }
    
    .group:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Filled group styling */
    .group.filled {
      box-shadow: 0 0 10px 0 rgba(230, 151, 59, 0.35);
      border: 1px solid rgba(230, 151, 59, 0.3);
    }
    
    .group.filled::before {
      background: var(--filled-glow);
    }
    
    .group h2 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .group.filled h2 {
      color: var(--filled-glow);
    }
    
    /* Player list styling */
    .player-list {
      list-style: none;
      padding: 0;
      margin-top: 1rem;
    }
    
    .player-list li {
      padding: 0.7rem 0.5rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.2s ease;
    }
    
    .player-list li:hover {
      background-color: var(--bg-tertiary);
      border-radius: var(--radius-sm);
    }
    
    .player-list li:last-child {
      border-bottom: none;
    }
    
    /* Timezone indicator */
    .timezone {
      font-size: 1rem;
      margin-top: 0.5rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .timezone::before {
      content: 'ðŸ•’';
      font-size: 0.9rem;
    }
    
    /* Footer styles */
    footer {
      text-align: center;
      margin-top: 3rem;
      font-size: 0.9rem;
      color: var(--text-tertiary);
      padding: 1rem 0;
      border-top: 1px solid var(--border-light);
    }
    
    /* Loading indicator */
    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.2rem;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    
    .loading::after {
      content: '';
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-radius: 50%;
      border-top-color: var(--accent-primary);
      animation: loading 1s infinite linear;
    }
    
    @keyframes loading {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Last updated text */
    .last-updated {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: var(--text-tertiary);
      font-style: italic;
    }
    
    /* User panel styles */
    .user-panel {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .user-actions {
      display: flex;
      gap: 0.8rem;
    }

    /* Button styles */
    .btn {
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background-color: var(--accent-primary);
      color: white;
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-danger {
      background-color: #e44f4f;
      color: white;
    }

    .btn-success {
      background-color: var(--guild-color);
      color: black;
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Join/leave buttons */
    .join-btn {
      background-color: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .join-btn:hover {
      filter: brightness(1.1);
    }

    .leave-btn {
      background-color: #e44f4f;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .leave-btn:hover {
      filter: brightness(1.1);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: var(--bg-secondary);
      padding: 2rem;
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .modal h3 {
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      font-size: 1.5rem;
      text-align: center;
    }

    /* Form group styling */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .form-group input {
      width: 100%;
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-group input:focus {
      outline: 2px solid var(--accent-primary);
    }

    /* Form actions */
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 2rem;
    }

    /* Alert messages */
    .alert {
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .alert-error {
      background-color: rgba(228, 79, 79, 0.2);
      border: 1px solid rgba(228, 79, 79, 0.5);
      color: #f8b3b3;
    }

    .alert-success {
      background-color: rgba(74, 222, 128, 0.2);
      border: 1px solid rgba(74, 222, 128, 0.5);
      color: #b3f8c4;
    }

    /* Role badges */
    .role-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: var(--radius-lg);
      font-size: 0.75rem;
      margin-left: 0.5rem;
      font-weight: 500;
    }

    .role-badge.admin {
      background-color: #f87171;
      color: white;
    }
    
    .role-badge.guild-master {
      background-color: #e68c1a;
      color: white;
    }

    .role-badge.advisor {
      background-color: #8b5cf6;
      color: white;
    }

    .role-badge.staff {
      background-color: #ec4899;
      color: white;
    }

    .role-badge.officer {
      background-color: var(--accent-primary);
      color: white;
    }

    .role-badge.member {
      background-color: #2d9a51;
      color: white;
    }

    .role-badge.mercenary {
      background-color: var(--merc-color);
      color: white;
    }

    /* Autocomplete Styles */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border-light);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      z-index: 200;
      display: none;
      box-shadow: var(--shadow-md);
    }

    .autocomplete-option {
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
    }

    .autocomplete-option:hover {
      background-color: var(--bg-tertiary);
    }

    .autocomplete-option:last-child {
      border-bottom: none;
    }

    /* Sidebar styles */
    #userSidebar {
      position: fixed;
      left: 20px;
      top: 103px;
      width: 280px;
      background-color: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
      z-index: 40;
      max-height: calc(100vh - 140px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 1rem;
      background-color: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60px;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--text-primary);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .sidebar-content {
      padding: 0.5rem;
      overflow-y: auto;
      flex-grow: 1;
      scrollbar-gutter: stable; /* Prevents content shift when scrollbar appears */
      padding-right: 4px; /* Add small padding to prevent scrollbar overlapping content */
    }

    /* User list items */
    .user-list-item {
      display: flex;
      align-items: center;
      padding: 0.8rem 1rem;
      margin: 0.3rem 0;
      border-radius: var(--radius-sm);
      background-color: var(--bg-tertiary);
      transition: background-color 0.2s ease;
    }

    .user-list-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .user-list-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 1rem;
      object-fit: cover;
    }

    .user-list-name {
      font-size: 1.1rem;
      color: var(--text-primary);
      flex-grow: 1;
    }

    .user-list-role {
      margin-left: 0.5rem;
    }

    /* Custom scrollbar for sidebar */
    .sidebar-content::-webkit-scrollbar {
      width: 8px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 4px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }

    /* For Firefox */
    .sidebar-content {
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-tertiary);
    }

    /* Collapsible sidebar styles */
    .sidebar-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: transform 0.3s ease;
    }

    .sidebar-toggle svg {
      transition: transform 0.3s ease;
    }

    .sidebar-toggle:hover {
      opacity: 0.8;
    }

    #userSidebar.collapsed {
      width: 50px;
      overflow: hidden;
      transition: width 0.3s ease;
    }

    #userSidebar.collapsed .sidebar-content {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #userSidebar.collapsed .sidebar-header h3 {
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #userSidebar.collapsed .sidebar-toggle svg {
      transform: rotate(180deg);
    }

    .sidebar-header {
      position: relative;
      transition: all 0.3s ease;
    }
    
    /* Drop target highlighting */
    .player-list li.highlight-drop {
      background-color: rgba(61, 132, 247, 0.5) !important;
      transform: scale(1.02);
      transition: all 0.2s ease;
    }

    .player-list li[draggable="true"] {
      cursor: grab;
    }
    .player-list li[draggable="true"]:active {
      cursor: grabbing;
    }

    /* Draggable user items */
    .user-list-item[draggable="true"] {
      cursor: grab;
    }

    .user-list-item[draggable="true"]:active {
      cursor: grabbing;
    }

    #floating-user-info {
      z-index: 40;
    }

    /* User Dropdown Styles */
    .user-dropdown {
      position: fixed;
      top: 120px;
      right: 20px;
      background-color: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
      padding: 0.5rem 0;
      z-index: 100;
      display: none;
      min-width: 150px;
    }

    .user-dropdown.show {
      display: block;
    }

    .dropdown-item {
      display: block;
      padding: 0.5rem 1rem;
      color: var(--text-primary);
      text-decoration: none;
      transition: background-color 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: inherit;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background-color: var(--bg-tertiary);
    }

    /* Dropdown Avatar Styles */
    .dropdown-avatar-container {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid var(--border-light);
    }

    .avatar-wrapper {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }

    .dropdown-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: stretch; /* Changed from center to stretch */
      justify-content: center;
      overflow: hidden;
      border: 3px solid var(--accent-primary);
      box-shadow: 0 0 10px rgba(61, 132, 247, 0.5);
      transition: all 0.2s ease;
      cursor: pointer;
      padding: 0; /* Explicitly remove padding */
      margin: 0; /* Explicitly remove margin */
      box-sizing: border-box; /* Include border in dimensions */
      background: var(--bg-tertiary); /* Fallback background */
    }

    .dropdown-avatar:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(61, 132, 247, 0.8);
    }

    /* Default Avatar Style */
    .default-avatar {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--accent-primary);
      color: white;
      font-size: 40px;
      font-weight: bold;
    }

    /* Avatar Image */
    .dropdown-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: inherit;
      display: block; /* Remove inline spacing */
      min-width: 100%; /* Ensure full coverage */
      min-height: 100%; /* Ensure full coverage */
    }

    .dropdown-avatar .default-avatar {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      transition: inherit;
      margin: 0; /* Remove any default margins */
      flex: 1; /* Fill available space */
    }

    .avatar-edit-icon {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background: rgba(0, 0, 0, 0.2);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
    }

    .avatar-edit-icon svg {
      color: white;
      stroke: white;
      stroke-width: 2px;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .avatar-edit-icon:hover svg {
      opacity: 1;     /* Full opacity on hover */
    }

    .dropdown-divider {
      height: 1px;
      background-color: var(--border-light);
      margin: 0.5rem 0;
    }

    /* SortableJS classes */
    .sortable-ghost {
      opacity: 0.5;
      background-color: rgba(61, 132, 247, 0.3) !important;
      transition: all 0.3s ease !important;
    }

    .sortable-chosen {
      opacity: 0.8;
      transform: scale(1.02);
      transition: all 0.3s ease !important;
    }

    /* Profile hover card */
    .profile-hover-card {
      position: fixed;
      width: 400px;
      height: 225px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .profile-hover-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.2); /* Dark overlay for better text visibility */
      z-index: 1;
    }
    
    .profile-hover-card.visible {
      display: block;
      opacity: 1;
    }

    .profile-hover-card .role-badge {
      margin: 0.15rem 0.25rem 0.15rem 0 !important;
      display: inline-block;
    }
    
    .hover-card-header {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-light);
      background: rgba(30, 30, 30, 0.7); /* Semi-transparent dark background */
      position: relative;
      z-index: 2;
    }
    
    .hover-avatar-container {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      overflow: hidden;
      margin-right: 1rem;
      border: 2px solid var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .hover-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .hover-name-role {
      flex: 1;
      position: relative;
      z-index: 2;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.25rem;
    }
    
    .hover-card-body {
      padding: 1rem;
      position: relative;
      z-index: 2;
    }
    
    .hover-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    
    .hover-stat {
      text-align: center;
      flex: 1;
      background: rgba(30, 30, 30, 0.7);
      padding: 0.9rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
    }
    
    .hover-stat span {
      display: block;
      font-size: 0.8rem;
      color: var(--text-tertiary);
    }
    
    .hover-stat strong {
      font-size: 1.2rem;
      color: var(--accent-primary);
    }

    .hover-class {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    
    .hover-screenshot-container {
      width: 318px; /* 350px - 16px padding on each side */
      height: 120px; /* Adjusted height to fit within fixed dimensions */
      margin: 0 auto;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    
    .hover-screenshot-container.visible {
      display: block;
    }
    
    .hover-screenshot {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .user-dropdown {
        top: 110px;
        right: 10px;
        left: 10px;
        width: calc(100% - 20px);
      }
    }

    /* Hide sidebar on mobile */
    @media (max-width: 1200px) {
      #userSidebar {
        display: none;
      }
    }
    
    /* For small devices */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .container {
        padding: 1rem;
        margin: 1rem auto;
        border-radius: 0;
      }
      
      header {
        padding: 1rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .description {
        font-size: 0.95rem;
      }
      
      .roster {
        grid-template-columns: 1fr;
      }
      
      .user-panel {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }
      
      .user-actions {
        width: 100%;
        justify-content: flex-end;
      }
      img[alt][src*="badges/"] {
        border-radius: 2px;
        vertical-align: middle;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="userSidebar">
    <div class="sidebar-header">
      <h3>Users</h3>
      <button id="sidebarToggle" class="sidebar-toggle">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" fill="white"/>
        </svg>
      </button>
    </div>
    <div class="sidebar-content" id="userList">
      <div class="loading">Loading users...</div>
    </div>
  </div>
  <header>
    <div class="header-container">
      <a href="./" class="header-title" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 8px;">
        <img src="assets/images/favicon-32x32.png" alt="Hexed Logo" width="24" height="24" style="filter: drop-shadow(0 0 2px rgba(0,0,0,0.5))">
        <span>Hexed</span>
      </a>
      <div class="user-panel" id="userPanel">
        <!-- Content will be dynamically generated -->
      </div>
    </div>
  </header>
  <!-- Dropdown Panel -->
  <div id="user-dropdown" class="user-dropdown">
    <div class="dropdown-avatar-container">
      <div class="avatar-wrapper">
        <!-- Updated avatar with default icon fallback -->
        <div id="dropdown-avatar" class="dropdown-avatar">
        </div>
        <div class="avatar-edit-icon">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="white">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
        </div>
      </div>
    </div>
    <a href="pages/profile/index.html" class="dropdown-item" id="profile-link">Profile</a>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item" id="logout-btn">Logout</button>
  </div>
  
  <div id="floating-user-info"></div>

  <div class="container">
    <h1>Hexed Party Boss Blitz Roster</h1>
    
    <div class="description">
      This page organizes static groups for the weekly <strong>Party Boss Blitz</strong> content.<br>
      <strong><span class="player-guild">Guild members (âœ”)</span> have priority</strong>. <span class="player-merc">Mercenaries (âœ¦)</span> are welcome to fill in but may be replaced if a guild member signs up.
    </div>
    
	<nav>
	  <!-- Normal Mode - Single Sword (Akar Icons) -->
	  <button onclick="setSection('normal')" id="btn-normal" class="active">
		<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
		  <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
			<path d="m18 3l4-1l-1 4l-10 10l-2.5-.5L8 13zM2 20l2 2m1-8l1 4l4 1m-4-1l-3 3"/>
		  </g>
		</svg>
		Normal Mode
	  </button>

	  <!-- Hard Mode - Crossed Swords (Lucide) -->
	  <button onclick="setSection('hard')" id="btn-hard">
		<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
		  <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
			<path d="M14.5 17.5L3 6V3h3l11.5 11.5M13 19l6-6m-3 3l4 4m-1 1l2-2M14.5 6.5L18 3h3v3l-3.5 3.5M5 14l4 4m-2-1l-3 3m-1-1l2 2"/>
			<path d="M15 6l5 5m-4-4l3 3" stroke="#ff6b6b"/>
		  </g>
		</svg>
		Hard Mode
	  </button>

	  <!-- Re-runs - Circular Arrow -->
	  <button onclick="setSection('rerun')" id="btn-rerun">
		<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
		  <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
			<path d="M1 4v6h6M23 20v-6h-6"/>
			<path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
		  </g>
		</svg>
		Re-runs / Fill-ins
	  </button>
	</nav>
    
    <div class="time-notice">Times are displayed in your local time zone</div>
    
    <div class="roster" id="roster">
      <div class="loading">Loading roster data...</div>
    </div>
    
    <div class="last-updated" id="lastUpdated"></div>
    
    <footer>
      Powered by Hexed &middot; User Managed Roster
    </footer>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h3>Login</h3>
      <div id="loginAlert" class="alert alert-error" style="display: none;"></div>
      <div class="form-group">
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" placeholder="Enter your character name">
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password">
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('loginModal')">Cancel</button>
        <button class="btn btn-primary" id="loginSubmitBtn">Login</button>
      </div>
      <p style="text-align: center; margin-top: 1rem; color: var(--text-tertiary);">
        Don't have an account? <a href="#" onclick="openModal('registerModal'); closeModal('loginModal');" style="color: var(--accent-primary);">Register</a>
      </p>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <h3>Register</h3>
      <div id="registerAlert" class="alert alert-error" style="display: none;"></div>
      <div class="form-group">
        <label for="registerUsername">Character Name</label>
        <input type="text" id="registerUsername" placeholder="Enter your character name">
      </div>
      <div class="form-group">
        <label for="registerPassword">Password</label>
        <input type="password" id="registerPassword" placeholder="Create a password">
      </div>
      <div class="form-group">
        <label for="registerConfirmPassword">Confirm Password</label>
        <input type="password" id="registerConfirmPassword" placeholder="Confirm your password">
      </div>
      <div class="form-group">
        <label for="registerRole">Role</label>
        <select id="registerRole" style="width: 100%; padding: 0.8rem; border-radius: var(--radius-sm); background-color: var(--bg-tertiary); border: 1px solid var(--border-light); color: var(--text-primary); font-family: inherit;">
          <option value="member">Guild Member</option>
          <option value="mercenary">Mercenary</option>
        </select>
      </div>
      <div class="form-group" id="officerCodeGroup" style="display: none;">
        <label for="officerCode">Officer Code</label>
        <input type="password" id="officerCode" placeholder="Enter officer access code">
        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
          Only required for officer roles. Ask your guild leader for the code.
        </small>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('registerModal')">Cancel</button>
        <button class="btn btn-primary" id="registerSubmitBtn">Register</button>
      </div>
      <p style="text-align: center; margin-top: 1rem; color: var(--text-tertiary);">
        Already have an account? <a href="#" onclick="openModal('loginModal'); closeModal('registerModal');" style="color: var(--accent-primary);">Login</a>
      </p>
    </div>
  </div>

  <!-- Admin Panel Modal -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <h3>Admin Panel</h3>
      <div id="adminAlert" class="alert" style="display: none;"></div>
      
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Role Management</h4>
        <div class="form-group">
          <label for="adminUsername">Username</label>
          <div class="autocomplete-wrapper">
            <input type="text" id="adminUsername" placeholder="Enter username to modify" autocomplete="off">
            <div id="userSuggestions" class="autocomplete-results"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="adminRole">New Role</label>
          <select id="adminRole" style="width: 100%; padding: 0.8rem; border-radius: var(--radius-sm); background-color: var(--bg-tertiary); border: 1px solid var(--border-light); color: var(--text-primary); font-family: inherit;">
            <option value="member">Member</option>
            <option value="mercenary">Mercenary</option>
            <option value="officer">Officer</option>
            <option value="staff">Staff</option>
            <option value="advisor">Advisor</option>
            <option value="guild-master">Guild Master</option>
            <option value="admin-toggle">Toggle Admin Status</option>
          </select>
        </div>
        <button class="btn btn-primary" id="updateRoleBtn" style="margin-top: 0.5rem;">Update Role</button>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Roster Management</h4>
        <button class="btn btn-danger" id="resetRosterBtn">Reset Roster</button>
        <button class="btn btn-secondary" id="exportRosterBtn" style="margin-left: 0.5rem;">Export Roster</button>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('adminModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Group Modal -->
  <div class="modal" id="editGroupModal">
    <div class="modal-content">
      <h3>Edit Group</h3>
      <div id="editGroupAlert" class="alert" style="display: none;"></div>
      
      <div class="form-group">
        <label for="editGroupName">Group Name</label>
        <input type="text" id="editGroupName" placeholder="Group name">
      </div>
      
      <div class="form-group">
        <label for="editGroupTime">Time (UTC)</label>
        <input type="text" id="editGroupTime" placeholder="Example: 20:00">
      </div>

      <div class="form-group">
        <label for="editGroupDate">Date or Day (e.g. Friday or 2025-04-27)</label>
        <input type="text" id="editGroupDate" placeholder="e.g. Friday or 2025-04-27">
      </div>
      
      <div class="form-group">
        <label>Group Members</label>
        <div id="editGroupMembers">
          <!-- Dynamically generated member list -->
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('editGroupModal')">Cancel</button>
        <button class="btn btn-primary" id="saveGroupChangesBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="profileHoverCard" class="profile-hover-card">
    <div class="hover-card-header">
      <div class="hover-avatar-container">
        <img id="hoverAvatar" class="hover-avatar" src="" alt="Avatar" style="display:none">
        <div class="default-avatar" style="display:none"></div>
      </div>
      <div class="hover-name-role">
        <h3 id="hoverUsername"></h3>
        <div id="hoverClass" class="hover-class"></div>
        <span id="hoverRoleBadge" class="role-badge"></span>
      </div>
    </div>
    <div class="hover-card-body">
      <div class="hover-stats">
        <div class="hover-stat">
          <span>AP</span>
          <strong id="hoverAP">0</strong>
        </div>
        <div class="hover-stat">
          <span>DP</span>
          <strong id="hoverDP">0</strong>
        </div>
        <div class="hover-stat">
          <span>GS</span>
          <strong id="hoverGS">0</strong>
        </div>
      </div>
    </div>
  </div>
	
  <script>
    // Current active section
    let currentSection = 'normal';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCW9u1BBa7draopIS0ZnVLpV0TcRDGQ0M",
      authDomain: "hexed-42069.firebaseapp.com",
      projectId: "hexed-42069",
      storageBucket: "hexed-42069.firebasestorage.app",
      messagingSenderId: "358734713369",
      appId: "1:358734713369:web:43b3e02b4b52401a115088",
      measurementId: "G-E4ZKRD1R9S",
      databaseURL: "https://hexed-42069-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    const IMGUR_CLIENT_ID = '39f8c230782d6da'; // Replace with Client ID from Imgur

    async function uploadToImgur(file) {
      if (!file || !currentUser) return;

      const formData = new FormData();
      formData.append("image", file);

      try {
        const response = await fetch("https://api.imgur.com/3/image", {
          method: "POST",
          headers: {
            Authorization: `Client-ID ${IMGUR_CLIENT_ID}`
          },
          body: formData
        });

        const data = await response.json();

        if (!data.success) {
          alert("Failed to upload image");
          return;
        }

        const imageUrl = data.data.link;

        // Save URL in Firebase
        await firebase.database().ref(`users/${currentUser.uid}/photoURL`).set(imageUrl);
        updateDropdownAvatar(); // Add this line
        updateUserPanel(); // Refresh all user displays
    
        // Update both avatars
        const avatars = document.querySelectorAll('.user-avatar img, .dropdown-avatar');
        avatars.forEach(avatar => {
          avatar.src = imageUrl;
        });
    
        alert("Profile picture uploaded!");
      } catch (error) {
        console.error("Imgur upload error:", error);
        alert("Error uploading image");
      }
    }

    // Store the fetched data
    const allData = {
      normal: [],
      hard: [],
      reruns: []
    };

    function getActualSection(sectionName) {
      return sectionName === 'rerun' ? 'reruns' : sectionName;
    }

    // Store authenticated user info
    let currentUser = null;

    // Load all profile photos once when the page starts
    async function loadAllUserPhotos() {
      const snapshot = await database.ref('users').once('value');
      const users = snapshot.val() || {};
      window.allUserPhotos = {};
      window.allUserRoles = {};
      window.allUserAdmins = {}; // New object to track admin status
    
      for (const uid in users) {
        const user = users[uid];
        if (user.username) {
          if (user.photoURL) {
            window.allUserPhotos[user.username] = user.photoURL;
          }
          window.allUserRoles[user.username] = user.role;
          window.allUserAdmins[user.username] = user.isAdmin || false;
        }
      }
    }

    // Helper function to load all suggestions
    function loadAllSuggestions(container, input) {
      const allUsers = Object.keys(window.allUserRoles || {})
        .sort((a, b) => a.localeCompare(b))
        .slice(0, 50); // limit to 50 results
      showSuggestions(allUsers, container, input);
    }

    // Helper function to filter suggestions
    function filterSuggestions(search, container, input) {
      if (search === '') {
        loadAllSuggestions(container, input);
        return;
      }

      const matchedUsers = Object.keys(window.allUserRoles || {})
        .filter(name => name.toLowerCase().includes(search))
        .sort((a, b) => a.localeCompare(b))
        .slice(0, 50); // limit to 50 results

      showSuggestions(matchedUsers, container, input);
    }

    // Helper function to display suggestions
    function showSuggestions(users, container, input) {
      container.innerHTML = '';
  
      if (users.length === 0) {
        container.style.display = 'none';
        return;
      }

      users.forEach(name => {
        const avatar = window.allUserPhotos[name] || null;
        const role = window.allUserRoles[name] || 'member';
        const option = document.createElement('div');
        option.className = 'autocomplete-option';
        option.innerHTML = `
          ${avatar ? `<img src="${avatar}" style="width: 24px; height: 24px; border-radius: 50%;">` : ''}
          <strong>${name}</strong>
          <span class="role-badge ${role}" style="margin-left: auto;">${role.replace('-', ' ')}</span>
        `;
        option.addEventListener("click", () => {
          input.value = name;
          container.style.display = 'none';
        });
        container.appendChild(option);
      });
  
      container.style.display = 'block';
    }

    function setupAdminAutocomplete() {
      const input = document.getElementById("adminUsername");
      const suggestionsBox = document.getElementById("userSuggestions");

      if (!input || !suggestionsBox) return;

      // Clear previous event listeners to avoid duplicates
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      const newSuggestionsBox = suggestionsBox.cloneNode(true);
      suggestionsBox.parentNode.replaceChild(newSuggestionsBox, suggestionsBox);

      // Get fresh references
      const freshInput = document.getElementById("adminUsername");
      const freshSuggestionsBox = document.getElementById("userSuggestions");

      // Only show suggestions when input is focused/clicked
      freshInput.addEventListener("focus", function() {
        loadAllSuggestions(freshSuggestionsBox, freshInput);
        freshSuggestionsBox.style.display = 'block';
      });

      // Handle input typing
      freshInput.addEventListener("input", function() {
        const search = freshInput.value.toLowerCase().trim();
        filterSuggestions(search, freshSuggestionsBox, freshInput);
      });

      // Hide suggestions when clicking outside
      document.addEventListener("click", function(e) {
        if (!freshInput.contains(e.target) && !freshSuggestionsBox.contains(e.target)) {
          freshSuggestionsBox.style.display = 'none';
        }
      });
    }
    
    // Initialize the app
    async function init() {
      // Set up Firebase auth state listener
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // Add delay to ensure all data is written
          await new Promise(resolve => setTimeout(resolve, 500));
          
          try {
            const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
            
            if (!userSnapshot.exists()) {
              // If data still doesn't exist after delay, force logout
              console.error('User data missing for:', user.uid);
              await auth.signOut();
              return;
            }
        
            const userData = userSnapshot.val();
            currentUser = {
              uid: user.uid,
              username: userData.username,
              role: userData.role,
              isAdmin: userData.isAdmin || false,
              photoURL: userData.photoURL || null
            };
            
            updateUserPanel();
            await loadAllUsers();
            
          } catch (error) {
            console.error('Auth state error:', error);
            await auth.signOut();
          }
        } else {
          currentUser = null;
          updateUserPanel();
          await loadAllUsers();
        }
      });
  
      // Set up event listeners
      document.getElementById('loginSubmitBtn').addEventListener('click', handleLogin);
      document.getElementById('registerSubmitBtn').addEventListener('click', handleRegister);
      
      // Register role selection
      document.getElementById('registerRole').addEventListener('change', function() {
        const officerCodeGroup = document.getElementById('officerCodeGroup');
        if (this.value === 'officer') {
          officerCodeGroup.style.display = 'block';
        } else {
          officerCodeGroup.style.display = 'none';
        }
      });
      
      // Admin panel functionality
      document.getElementById('updateRoleBtn').addEventListener('click', updateUserRole);
      document.getElementById('resetRosterBtn').addEventListener('click', resetRoster);
      document.getElementById('exportRosterBtn').addEventListener('click', exportRoster);
      
      try {
        await initializeDatabase();
        await loadAllUserPhotos();
        setupAdminAutocomplete();
        await loadAllUsers();
        await fetchAllData();
      } catch (error) {
        console.error("Initialization error:", error);
        document.getElementById('roster').innerHTML = `<div class="loading">Error initializing application: ${error.message}</div>`;
      }
    }

    // Initialize the database with default structure if empty
    async function initializeDatabase() {
      try {
        const snapshot = await database.ref('roster').once('value');
        if (!snapshot.exists()) {
          console.log('Creating initial database structure');
          // Default empty structure
          const defaultData = {
            normal: Array.from({ length: 10 }, (_, i) => ({
              group: `Normal Group ${i + 1}`,
              timeUTC: i % 2 === 0 ? "20:00" : "22:00",
              players: ["", "", "", "", ""]
            })),
            hard: Array.from({ length: 10 }, (_, i) => ({
              group: `Hard Group ${i + 1}`,
              timeUTC: i % 2 === 0 ? "19:00" : "21:00",
              players: ["", "", "", "", ""]
            })),
            reruns: Array.from({ length: 10 }, (_, i) => ({
              group: `Rerun Group ${i + 1}`,
              timeUTC: i % 2 === 0 ? "18:00" : "23:00",
              players: ["", "", "", "", ""]
            }))
          };
          
          await database.ref('roster').set(defaultData);
          console.log('Database initialized with default structure');
        }
      } catch (error) {
        console.error('Error initializing database:', error);
        throw error; // Re-throw to be caught by the calling function
      }
    }
    
    // =====================
    // User Authentication
    // =====================
    
    // Get user data from Firebase
    async function getUserData(uid) {
      const snapshot = await database.ref(`users/${uid}`).once('value');
      return snapshot.val();
    }
    
    // Update the user panel based on login status
    function updateUserPanel() {
      const panel = document.getElementById('userPanel');
      const floatingPanel = document.getElementById('floating-user-info');
    
      if (currentUser) {
        // User is logged in
        let roleBadge = '';
        if (currentUser.isAdmin) {
          roleBadge = '<span class="role-badge admin">Admin</span>';
        }
        if (currentUser.role === 'guild-master') {
          roleBadge += '<span class="role-badge guild-master">Guild Master</span>';
        } else if (currentUser.role === 'advisor') {
          roleBadge += '<span class="role-badge advisor">Advisor</span>';
        } else if (currentUser.role === 'staff') {
          roleBadge += '<span class="role-badge staff">Staff</span>';
        } else if (currentUser.role === 'officer') {
          roleBadge += '<span class="role-badge officer">Officer</span>';
        } else if (currentUser.role === 'member') {
          roleBadge += '<span class="role-badge member">Member</span>';
        } else if (currentUser.role === 'mercenary') {
          roleBadge += '<span class="role-badge mercenary">Mercenary</span>';
        }

        // Generate color from username for the avatar background
        const color = stringToColor(currentUser.username);
        const initial = currentUser.username.charAt(0).toUpperCase();

        // Floating panel (avatar + username - now clickable)
        floatingPanel.innerHTML = `
          <div class="user-info" style="position: fixed; top: 88px; right: 20px; display: flex; align-items: center; gap: 8px; cursor: pointer; z-index: 51;" id="user-info-clickable">
            <div class="user-avatar" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background-color: ${color}; color: white; font-weight: bold;">
              ${currentUser.photoURL ? `<img src="${currentUser.photoURL}" alt="avatar" style="width:32px;height:32px;border-radius:50%;">` : initial}
            </div>
            <div>
              <span>${currentUser.username}</span>
              ${roleBadge}
            </div>
          </div>
        `;

        // Original panel (keeps all buttons except logout)
        panel.innerHTML = `
          <div class="user-actions">
            <input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="uploadToImgur(this.files[0])" />
            ${currentUser?.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser?.role) ? 
              `<button class="admin-panel-btn" onclick="openModal('adminModal')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
                Admin Panel
              </button>` : ''}
          </div>
        `;

        // Add dropdown functionality
        updateDropdownAvatar();
        setupDropdown();

      } else {
        floatingPanel.innerHTML = '';
        panel.innerHTML = `
          <div class="user-actions">
            <button class="btn btn-secondary" onclick="openModal('registerModal')">Register</button>
            <button class="btn btn-primary" onclick="openModal('loginModal')">Login</button>
          </div>
        `;
      }
    }

    function setupDropdown() {
      updateDropdownAvatar();

      // Get elements
      const userInfo = document.getElementById('user-info-clickable');
      const dropdown = document.getElementById('user-dropdown');
      const dropdownAvatar = document.getElementById('dropdown-avatar');
      const avatarWrapper = document.querySelector('.avatar-wrapper');
      const profileLink = document.getElementById('profile-link');
      const logoutBtn = document.getElementById('logout-btn');
  
      if (!userInfo || !dropdown) return;
  
      // Set dropdown avatar
      if (dropdownAvatar && currentUser) {
        dropdownAvatar.src = currentUser.photoURL || '';
        dropdownAvatar.onerror = function() {
          // Fallback if image fails to load
          const initial = currentUser.username.charAt(0).toUpperCase();
          const color = stringToColor(currentUser.username);
          dropdownAvatar.src = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="${color}"/><text x="50" y="60" font-size="50" text-anchor="middle" fill="white">${initial}</text></svg>`;
        };
      }
  
      // Toggle dropdown visibility
      userInfo.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdown.classList.toggle('show');
      });
  
      // Avatar upload functionality
      if (avatarWrapper) {
        avatarWrapper.addEventListener('click', function(e) {
          e.preventDefault();
          document.getElementById('profilePicInput').click();
        });
      }
  
      // Profile link handler
      if (profileLink) {
        profileLink.addEventListener('click', function(e) {
          closeDropdown();
          console.log("Navigate to profile");
          // window.location.href = '/profile';
        });
      }
  
      // Logout button handler
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          closeDropdown();
          handleLogout();
        });
      }
  
      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!dropdown.contains(e.target) && !userInfo.contains(e.target)) {
          closeDropdown();
        }
      });
  
      // Refresh avatar when new one is uploaded
      document.getElementById('profilePicInput').addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            if (dropdownAvatar) {
              dropdownAvatar.src = e.target.result;
            }
          };
          reader.readAsDataURL(this.files[0]);
        }
      });
    }

    function closeDropdown() {
      const dropdown = document.getElementById('user-dropdown');
      if (dropdown) dropdown.classList.remove('show');
    }
    
    // Handle login form submission
    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const alertElement = document.getElementById('loginAlert');
      
      if (!username || !password) {
        showAlert(alertElement, 'Please enter both username and password', 'error');
        return;
      }
      
      try {
        // Find user by username
        const usersSnapshot = await database.ref('usernames').once('value');
        const users = usersSnapshot.val() || {};
        
        if (!users[username]) {
          showAlert(alertElement, 'User not found', 'error');
          return;
        }
        
        const uid = users[username];
        
        // Sign in with email/password (using the UID as email for simplicity)
        await auth.signInWithEmailAndPassword(`${username.toLowerCase()}@hexed.com`, password);
        
        // Login successful - the auth state listener will handle the rest
        closeModal('loginModal');
        
        // Clear form
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      } catch (error) {
        console.error('Login error:', error);
        showAlert(alertElement, error.message, 'error');
      }
    }
    
    // Handle registration form submission
    async function handleRegister() {
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value.trim();
      const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
      const role = document.getElementById('registerRole').value;
      const officerCode = document.getElementById('officerCode').value.trim();
      const alertElement = document.getElementById('registerAlert');

      if (!username || !password || !confirmPassword) {
        showAlert(alertElement, 'Please fill in all fields', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showAlert(alertElement, 'Passwords do not match', 'error');
        return;
      }

      if (password.length < 6) {
        showAlert(alertElement, 'Password must be at least 6 characters', 'error');
        return;
      }

      try {
        // 1. First check username availability
        const usernameSnapshot = await database.ref(`usernames/${username}`).once('value');
        if (usernameSnapshot.exists()) {
          showAlert(alertElement, 'Username already taken', 'error');
          return;
        }
    
        // 2. Create auth user
        const fakeEmail = `${username}@hexed.com`;
        const userCredential = await auth.createUserWithEmailAndPassword(fakeEmail, password);
        const uid = userCredential.user.uid;
    
        // 3. Prepare all database updates
        const updates = {};
        updates[`users/${uid}`] = {
          username: username,
          role: role,
          isAdmin: false, // New users are not admins by default
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        updates[`usernames/${username}`] = uid;
    
        // 4. Execute all updates atomically
        await database.ref().update(updates);
    
        // 5. Clear form and close modal
        closeModal('registerModal');
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerConfirmPassword').value = '';
    
      } catch (error) {
        console.error('Registration error:', error);
        
        // Clean up if auth succeeded but database failed
        if (auth.currentUser) {
          try {
            await auth.currentUser.delete();
          } catch (deleteError) {
            console.error('Error cleaning up user:', deleteError);
          }
        }
    
        if (error.code === 'auth/email-already-in-use') {
          showAlert(alertElement, 'Username already registered', 'error');
        } else {
          showAlert(alertElement, error.message, 'error');
        }
      }
    }
    
    // Generate a simple UID
    function generateUid() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    // Handle logout
    function handleLogout() {
      auth.signOut();
    }
    
    // Update user role (admin function)
    async function updateUserRole() {
      const username = document.getElementById('adminUsername').value.trim();
      const newRole = document.getElementById('adminRole').value;
      const alertElement = document.getElementById('adminAlert');
    
      if (!username) {
        showAlert(alertElement, 'Please enter a username', 'error');
        return;
      }
    
      try {
        // Find user by username
        const usernamesSnapshot = await database.ref('usernames').once('value');
        const usernames = usernamesSnapshot.val() || {};
    
        if (!usernames[username]) {
          showAlert(alertElement, 'User not found', 'error');
          return;
        }
    
        const uid = usernames[username];
        const targetUserRef = database.ref(`users/${uid}`);
    
        // Check if we're updating admin status
        const isAdminUpdate = newRole === 'admin-toggle';
        
        if (isAdminUpdate) {
          // Toggle admin status
          const targetUserSnapshot = await targetUserRef.once('value');
          const currentAdminStatus = targetUserSnapshot.val().isAdmin || false;
          await targetUserRef.update({ isAdmin: !currentAdminStatus });
          showAlert(alertElement, `Toggled admin status for ${username}`, 'success');
        } else {
          // Regular role update
          const targetUserSnapshot = await targetUserRef.once('value');
          const targetUser = targetUserSnapshot.val();
    
          // Define assignable roles for each rank
          const assignableRoles = {
            'admin': ['guild-master', 'advisor', 'staff', 'officer', 'member', 'mercenary'],
            'guild-master': ['guild-master', 'advisor', 'staff', 'officer', 'member', 'mercenary'],
            'advisor': ['advisor', 'staff', 'officer', 'member', 'mercenary'],
            'staff': ['staff', 'officer', 'member', 'mercenary'],
            'officer': ['officer', 'member', 'mercenary'],
            'member': [],
            'mercenary': []
          };
    
          // Check if current user can assign this role
          const currentUserRole = currentUser.isAdmin ? 'admin' : currentUser.role;
          if (!assignableRoles[currentUserRole]?.includes(newRole)) {
            showAlert(alertElement, `You cannot assign the ${newRole} role`, 'error');
            return;
          }
    
          // Update role
          await targetUserRef.update({ role: newRole });
          showAlert(alertElement, `Changed ${username} to ${newRole}`, 'success');
        }
    
        document.getElementById('adminUsername').value = '';
      } catch (error) {
        console.error('Role update failed:', error);
        showAlert(alertElement, error.message, 'error');
      }
    }
    
    // =====================
    // Roster Management
    // =====================

    function getRoleBadgeImage(userData) {
      const badges = {
        "admin": "assets/images/badges/admin.png",
        "guild-master": "assets/images/badges/guild-master.png",
        "advisor": "assets/images/badges/advisor.png",
        "staff": "assets/images/badges/staff.png",
        "officer": "assets/images/badges/officer.png"
      };
      
      // Check isAdmin first, then fall back to role
      if (userData.isAdmin) {
        return badges["admin"];
      }
      return badges[userData.role] || null;
    }
    
    // Function to determine if a player is a guild member or mercenary
    function getPlayerType(name) {
      if (!name) return 'none';
      if (name.includes('âœ”')) return 'guild';
      if (name.includes('âœ¦')) return 'merc';
      return 'none';
    }

    // Function to clean up player name by removing symbols
    function cleanPlayerName(name) {
      if (!name) return '';
      return name.replace('âœ”', '').replace('âœ¦', '').trim();
    }

    // Function to convert UTC time to local time
    function convertUTCToLocal(utcTimeStr) {
      if (!utcTimeStr) return 'No time specified';
      
      try {
        if (utcTimeStr.toLowerCase() === 'tbd' || utcTimeStr.toLowerCase() === 'n/a') {
          return utcTimeStr;
        }
        
        const timeParts = utcTimeStr.trim().split(':');
        if (timeParts.length !== 2) {
          return utcTimeStr;
        }
        
        const hours = parseInt(timeParts[0], 10);
        const minutes = parseInt(timeParts[1], 10);
        
        if (isNaN(hours) || isNaN(minutes)) {
          return utcTimeStr;
        }
        
        const utcDate = new Date();
        utcDate.setUTCHours(hours, minutes, 0, 0);
        
        const localTimeStr = utcDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        return `${localTimeStr} (${utcTimeStr} UTC)`;
      } catch (error) {
        console.error("Error converting time:", error);
        return utcTimeStr;
      }
    }

    // Function to check if a group is filled (has all 5 players)
    function isGroupFilled(players) {
      if (!Array.isArray(players)) return false;
      
      let filledSlots = 0;
      for (let i = 0; i < players.length; i++) {
        if (players[i] && players[i].trim() !== '') {
          filledSlots++;
        }
      }
      
      return filledSlots === 5;
    }

    // Function to check if current user can join a group
    function canJoinGroup(groupData) {
      if (!currentUser) return false;
      
      // Admins and officers can always edit
      if (currentUser?.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser?.role)) return true;
      
      const processedPlayers = processPlayers(groupData.players || []);
      
      // Check if user is already in the group
      const isAlreadyInGroup = processedPlayers.some(p => p.name === currentUser.username);
      if (isAlreadyInGroup) return false;
      
      // Check if group is full
      if (isGroupFilled(groupData.players)) return false;
      
      return true;
    }

    // Function to check if current user can leave a group
    function canLeaveGroup(groupData) {
      if (!currentUser) return false;
      
      const processedPlayers = processPlayers(groupData.players || []);
      
      // Check if user is in the group
      return processedPlayers.some(p => p.name === currentUser.username);
    }

    // Function to process player data
    function processPlayers(players) {
      if (!Array.isArray(players)) {
        console.error("Expected players to be an array, got:", players);
        return [];
      }
      return players.map(player => {
        return {
          name: cleanPlayerName(player),
          type: getPlayerType(player)
        };
      });
    }

    // Function to join a group
    async function joinGroup(sectionName, groupIndex, slotIndex = null) {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      
      const group = allData[getActualSection(sectionName)][groupIndex];
      if (!group) return;
      
      // Ensure players array exists and has at least 5 slots
      if (!Array.isArray(group.players)) {
        group.players = Array(5).fill('');
      }
      while (group.players.length < 5) {
        group.players.push('');
      }
    
      // If specific slot was provided (from clicking a join button)
      if (slotIndex !== null) {
        // Check if the specific slot is available
        if (group.players[slotIndex] && group.players[slotIndex].trim() !== '') {
          alert('This slot is already occupied');
          return;
        }
        
        // Add user to the specific slot
        const symbol = currentUser.role === 'mercenary' ? 'âœ¦ ' : 'âœ” ';
        group.players[slotIndex] = symbol + currentUser.username;
      } 
      else {
        // Original behavior - find first available slot
        let emptySlotIndex = -1;
        for (let i = 0; i < group.players.length; i++) {
          if (!group.players[i] || group.players[i].trim() === '') {
            emptySlotIndex = i;
            break;
          }
        }
        
        if (emptySlotIndex === -1) {
          alert('No empty slots available');
          return;
        }
        
        // Add user to first available slot
        const symbol = currentUser.role === 'mercenary' ? 'âœ¦ ' : 'âœ” ';
        group.players[emptySlotIndex] = symbol + currentUser.username;
      }
      
      // Save to Firebase
      await database.ref(`roster/${getActualSection(sectionName)}/${groupIndex}`).set(group);
      
      // Re-render the roster
      renderGroups(allData[getActualSection(sectionName)]);
    }

    // Function to leave a group
    async function leaveGroup(sectionName, groupIndex) {
      if (!currentUser) return;

      const sectionKey = getActualSection(sectionName);
      const group = allData[sectionKey][groupIndex];
      if (!group) return;

      // Find the user in the group
      let userSlotIndex = -1;
      for (let i = 0; i < (group.players || []).length; i++) {
        if (group.players[i] && cleanPlayerName(group.players[i]) === currentUser.username) {
          userSlotIndex = i;
          break;
        }
      }

      if (userSlotIndex === -1) return;

      // Remove the user
      group.players[userSlotIndex] = '';

      // Clean up gaps
      group.players = group.players.filter(p => p && p.trim() !== '');
      while (group.players.length < 5) {
        group.players.push('');
      }

      // Save to Firebase
      await database.ref(`roster/${sectionKey}/${groupIndex}`).set(group);

      // âœ… NOW re-render
      renderGroups(allData[sectionKey]);
    }

    // Reset roster (admin function)
    async function resetRoster() {
      if (!currentUser || !(currentUser.isAdmin || ['guild-master', 'advisor', 'staff'].includes(currentUser.role))) {
        return;
      }
      
      if (!confirm("Are you sure you want to reset the roster? This will clear all current data.")) {
        return;
      }
      
      // Create empty structure
      const emptyData = {
        normal: [],
        hard: [],
        reruns: []
      };
      
      // Save to Firebase
      await database.ref('roster').set(emptyData);
      
      // Update the UI
      allData.normal = emptyData.normal;
      allData.hard = emptyData.hard;
      allData.reruns = emptyData.reruns;
      
      // Reset UI
      renderGroups(allData[currentSection]);
      
      const alertElement = document.getElementById('adminAlert');
      showAlert(alertElement, 'Roster has been reset', 'success');
    }

    // Export roster data
    function exportRoster() {
      const dataStr = JSON.stringify(allData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = 'hexed_roster.json';
      
      let linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    /*****************************************************************
     * HOVER PROFILE FUNCTIONALITY
     *****************************************************************/
    let hoverTimeout;
    const hoverCard = document.getElementById('profileHoverCard');
    const hoverElements = [];
    
    function initHoverProfiles() {
        // Clear previous listeners
        hoverElements.forEach(el => {
            el.removeEventListener('mouseenter', handleMouseEnter);
            el.removeEventListener('mouseleave', handleMouseLeave);
        });
        hoverElements.length = 0;
    
        // Add hover to roster player names
        document.querySelectorAll('.player-list li').forEach(item => {
            if (item.dataset.username || item.dataset.originalName) {
                const username = item.dataset.username || cleanPlayerName(item.dataset.originalName);
                item.dataset.username = username; // Ensure username is set
                item.addEventListener('mouseenter', handleMouseEnter);
                item.addEventListener('mouseleave', handleMouseLeave);
                hoverElements.push(item);
            }
        });
    
        // Add hover to sidebar user list
        document.querySelectorAll('.user-list-item').forEach(item => {
            if (item.dataset.username) {
                item.addEventListener('mouseenter', handleMouseEnter);
                item.addEventListener('mouseleave', handleMouseLeave);
                hoverElements.push(item);
            }
        });
    
        document.addEventListener('mousemove', positionHoverCard);
    }

    // New mouse enter handler with better state management
    function handleMouseEnter(e) {
        // Get username from either dataset attribute
        const username = this.dataset.username || cleanPlayerName(this.dataset.originalName);
        if (!username) return;
    
        // Clear any pending timeout
        if (this.hoverTimeout) {
            clearTimeout(this.hoverTimeout);
        }
    
        // Set a flag to track if we're still hovering
        this.isHovering = true;
    
        // Start the timeout to show the card
        this.hoverTimeout = setTimeout(async () => {
            if (!this.isHovering) return; // Check if we're still hovering
    
            try {
                const usernamesSnapshot = await database.ref('usernames').once('value');
                const uid = usernamesSnapshot.val()[username];
                if (!uid) return;
    
                const [userSnapshot, profileSnapshot] = await Promise.all([
                    database.ref(`users/${uid}`).once('value'),
                    database.ref(`profiles/${uid}`).once('value')
                ]);
    
                // Check again if we're still hovering before showing
                if (this.isHovering) {
                    updateHoverCard({
                        username,
                        ...userSnapshot.val(),
                        ...profileSnapshot.val() || {}
                    });
                    hoverCard.classList.add('visible');
                    positionHoverCard(e);
                }
            } catch (error) {
                console.error('Hover profile error:', error);
            }
        }, 300); // 300ms delay before showing
    }
    
    // New mouse leave handler
    function handleMouseLeave() {
        // Clear any pending timeout
        if (this.hoverTimeout) {
            clearTimeout(this.hoverTimeout);
            this.hoverTimeout = null;
        }
    
        // Mark as not hovering
        this.isHovering = false;
    
        // Hide the card immediately
        hideHoverProfile();
    }
    
    function showHoverProfile(username, e) {
      clearTimeout(hoverTimeout);
      hoverTimeout = setTimeout(async () => {
        try {
          const usernamesSnapshot = await database.ref('usernames').once('value');
          const uid = usernamesSnapshot.val()[username];
          if (!uid) return;
    
          const [userSnapshot, profileSnapshot] = await Promise.all([
            database.ref(`users/${uid}`).once('value'),
            database.ref(`profiles/${uid}`).once('value')
          ]);
    
          updateHoverCard({
            username,
            ...userSnapshot.val(),
            ...profileSnapshot.val() || {}
          });
          hoverCard.classList.add('visible');
          positionHoverCard(e);
        } catch (error) {
          console.error('Hover profile error:', error);
        }
      }, 300);
    }
    
    function updateHoverCard(data) {
      const hoverCard = document.getElementById('profileHoverCard');
      document.getElementById('hoverUsername').textContent = data.username;
      
      // Set character class if available
      const hoverClass = document.getElementById('hoverClass');
      hoverClass.textContent = data.characterClass || 'Class not specified';
      
      const roleBadge = document.getElementById('hoverRoleBadge');
      
      // Clear previous badges
      roleBadge.innerHTML = '';
      
      // Add admin badge if user is admin
      if (data.isAdmin) {
        const adminBadge = document.createElement('span');
        adminBadge.className = 'role-badge admin';
        adminBadge.textContent = 'Admin';
        adminBadge.style.marginRight = '0.5rem';
        roleBadge.appendChild(adminBadge);
      }
      
      // Add role badge
      const role = data.role || 'member';
      const roleBadgeText = document.createElement('span');
      roleBadgeText.className = `role-badge ${role}`;
      roleBadgeText.textContent = role.split('-').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
      roleBadge.appendChild(roleBadgeText);
    
      // Rest of the function remains the same...
      const hoverAvatar = document.getElementById('hoverAvatar');
      if (data.photoURL) {
        hoverAvatar.src = data.photoURL;
        hoverAvatar.style.display = 'block';
        hoverAvatar.nextElementSibling.style.display = 'none';
      } else {
        const firstLetter = data.username.charAt(0).toUpperCase();
        const colors = ['#FFB900', '#FF8C00', '#F7630C', '#CA5010', '#DA3B01', 
                       '#EF6950', '#D13438', '#FF4343', '#E74856', '#E81123'];
        const color = colors[firstLetter.charCodeAt(0) % colors.length];
        
        hoverAvatar.style.display = 'none';
        const defaultAvatar = hoverAvatar.nextElementSibling || document.createElement('div');
        defaultAvatar.className = 'default-avatar';
        defaultAvatar.style.display = 'flex';
        defaultAvatar.style.alignItems = 'center';
        defaultAvatar.style.justifyContent = 'center';
        defaultAvatar.style.width = '100%';
        defaultAvatar.style.height = '100%';
        defaultAvatar.style.backgroundColor = color;
        defaultAvatar.style.color = 'white';
        defaultAvatar.style.fontSize = '24px';
        defaultAvatar.style.fontWeight = 'bold';
        defaultAvatar.textContent = firstLetter;
        
        if (!hoverAvatar.nextElementSibling) {
          hoverAvatar.parentNode.appendChild(defaultAvatar);
        }
      }
    
      document.getElementById('hoverAP').textContent = data.ap || '0';
      document.getElementById('hoverDP').textContent = data.dp || '0';
      document.getElementById('hoverGS').textContent = ((parseInt(data.ap) || 0) + (parseInt(data.dp) || 0)).toString();
    
      if (data.characterScreenshot) {
        hoverCard.style.backgroundImage = `url(${data.characterScreenshot})`;
      } else {
        hoverCard.style.backgroundImage = '';
      }
    }
    
    function hideHoverProfile() {
        hoverCard.classList.remove('visible');
    }
    
    function positionHoverCard(e) {
        if (!hoverCard.classList.contains('visible')) return;
    
        const offset = 20;
        let left = e.clientX + offset;
        let top = e.clientY + offset;
    
        if (left + hoverCard.offsetWidth > window.innerWidth) {
            left = e.clientX - hoverCard.offsetWidth - offset;
        }
    
        if (top + hoverCard.offsetHeight > window.innerHeight) {
            top = e.clientY - hoverCard.offsetHeight - offset;
        }
    
        hoverCard.style.left = `${left}px`;
        hoverCard.style.top = `${top}px`;
    }
    
    // =====================
    // UI Helpers
    // =====================
    
    // Open modal
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }
    
    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
      
      // Clear alerts
      const alertElement = document.getElementById(`${modalId.replace('Modal', '')}Alert`);
      if (alertElement) {
        alertElement.style.display = 'none';
      }

      // Reset autocomplete specifically for admin modal
      if (modalId === 'adminModal') {
        const suggestionsBox = document.getElementById("userSuggestions");
        if (suggestionsBox) {
          suggestionsBox.innerHTML = '';
          suggestionsBox.style.display = 'none';
        }
        const usernameInput = document.getElementById("adminUsername");
        if (usernameInput) {
          usernameInput.value = '';
        }
      }      
    }
    
    // Show alert message
    function showAlert(element, message, type = 'error') {
      element.textContent = message;
      element.className = `alert alert-${type}`;
      element.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }
    
    // Function to render groups
    function renderGroups(data) {
        const container = document.getElementById('roster');
        container.innerHTML = '';
    
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="loading">No data available for this section.</div>';
            return;
        }
    
        data.forEach((group, groupIndex) => {
            const div = document.createElement('div');
            div.className = 'group';
    
            if (isGroupFilled(group.players)) {
                div.classList.add('filled');
            }
    
            let playerListHTML = '';
            const processedPlayers = processPlayers(group.players || []);
    
            // Make sure we always show 5 slots
            for (let i = 0; i < 5; i++) {
                const player = processedPlayers[i] || null;
            
                if (player && player.name) {
                    // Player slot with the option to leave if it's the current user
                    const isCurrentUser = currentUser && player.name === currentUser.username;
                    const leaveButton = isCurrentUser ? 
                        `<button class="leave-btn" onclick="leaveGroup('${currentSection}', ${groupIndex})">Leave</button>` : '';
                
                    const symbol = player.type === 'guild' ? 'âœ” ' : player.type === 'merc' ? 'âœ¦ ' : '';
                    const photoURL = (window.allUserPhotos && window.allUserPhotos[player.name]) || null;
    
                    playerListHTML += `
                        <li class="player-${player.type}" 
                            data-original-name="${symbol}${player.name}"
                            data-username="${player.name}"
                            style="display: flex; align-items: center; justify-content: space-between;"
                            ${currentUser && (currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser?.role)) ? 'draggable="true"' : ''}>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${photoURL ? `<img src="${photoURL}" alt="avatar" style="width:24px;height:24px;border-radius:50%;">` : ''}
                                <span class="player-name">
                                    ${symbol}${player.name}
                                    ${window.allUserRoles && window.allUserPhotos 
                                        ? (() => {
                                            const userRole = window.allUserRoles[player.name];
                                            const userData = { role: userRole, isAdmin: false };
                                            
                                            const isAdmin = window.allUserAdmins && window.allUserAdmins[player.name];
                                            
                                            if (isAdmin || getRoleBadgeImage({ role: userRole, isAdmin })) {
                                                return `<img src="${getRoleBadgeImage({ role: userRole, isAdmin })}" 
                                                            alt="${isAdmin ? 'admin' : userRole}" 
                                                            style="width: 20px; height: 20px; vertical-align: middle; margin-left: 5px;">`;
                                            }
                                            return '';
                                        })()
                                        : ''}
                                </span>
                            </div>
                            ${leaveButton}
                        </li>
                    `;
                } else {
                    // Empty slot with the option to join
                    const joinButton = currentUser && canJoinGroup(group) ?
                        `<button class="join-btn" onclick="joinGroup('${currentSection}', ${groupIndex}, ${i})">Join</button>` : '';
                
                    playerListHTML += `
                        <li data-empty-slot="true">
                            <span>- empty -</span>
                            ${joinButton}
                        </li>
                    `;
                }
            }
    
            // Admin/Officer edit button
            const editButton = currentUser && (currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) ?
                `<button class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.3rem 0.7rem;" onclick="editGroup('${currentSection}', ${groupIndex})">Edit</button>` : '';
    
            // Convert UTC time to local time
            const localTime = convertUTCToLocal(group.timeUTC);
            const groupDate = group.dateLabel ? `<div class="timezone">ðŸ“… ${group.dateLabel}</div>` : '';
    
            div.innerHTML = `
                <h2>${group.group} ${editButton}</h2>
                <div class="timezone">${localTime}</div>
                ${groupDate}
    
                <ul class="player-list">
                    ${playerListHTML}
                </ul>
            `;
            container.appendChild(div);
        });
    
        // Enable drag and drop for authorized users
        if (currentUser && (currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role))) {
            enableDragAndDrop();
        }
    
        // Initialize hover profiles for the newly rendered groups
        initHoverProfiles();
    }

    // Function to edit a group (for admins/officers)
    function editGroup(section, groupIndex) {
      if (!currentUser || !(currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role))) {
        return;
      }
  
      // Handle rerun section name mapping
      const actualSection = section === 'rerun' ? 'reruns' : section;
      const group = allData[actualSection][groupIndex];
      if (!group) return;

      // Fill the form with group data
      document.getElementById('editGroupName').value = group.group || '';
      document.getElementById('editGroupTime').value = group.timeUTC || '';
      document.getElementById('editGroupDate').value = group.dateLabel || '';

      // Fill member list
      const membersContainer = document.getElementById('editGroupMembers');
      membersContainer.innerHTML = '';
  
      for (let i = 0; i < 5; i++) {
        const playerName = group.players[i] || '';
    
        const memberInput = document.createElement('div');
        memberInput.className = 'form-group';
        memberInput.style.marginBottom = '0.5rem';
        memberInput.innerHTML = `
          <input type="text" id="editMember${i}" value="${playerName}" placeholder="Empty slot">
        `;
    
        membersContainer.appendChild(memberInput);
      }
  
      // Set up the save button
      document.getElementById('saveGroupChangesBtn').onclick = function() {
        saveGroupChanges(actualSection, groupIndex);
      };
  
      // Open the modal
      openModal('editGroupModal');
    }

    // Function to save group changes
    async function saveGroupChanges(section, groupIndex) {
      if (!currentUser || !(currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role))) {
        return;
      }
  
      // Handle section name mapping (important for re-runs)
      const actualSection = section === 'rerun' ? 'reruns' : section;
      const group = allData[actualSection][groupIndex];
      if (!group) return;

      // Get values from form
      group.group = document.getElementById('editGroupName').value.trim();
      group.timeUTC = document.getElementById('editGroupTime').value.trim();
      group.dateLabel = document.getElementById('editGroupDate').value.trim();
  
      // Get member list
      group.players = [];
      for (let i = 0; i < 5; i++) {
        const memberInput = document.getElementById(`editMember${i}`);
        group.players.push(memberInput.value.trim());
      }
  
      // Save to Firebase using the correct section name
      await database.ref(`roster/${actualSection}/${groupIndex}`).set(group);
  
      // Re-render using the current view section (not the internal section name)
      renderGroups(allData[getActualSection(currentSection)]);
  
      // Close the modal
      closeModal('editGroupModal');
    }

    // Function to set active section
    function setSection(section) {
      // Set current section for tracking
      currentSection = section;
      
      // Update UI to show active button
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`btn-${section}`).classList.add('active');
      
      // Map 'rerun' to 'reruns' in the data structure
      const dataSection = section === 'rerun' ? 'reruns' : section;
      
      // Check if we have data for this section
      if (allData[dataSection] && Array.isArray(allData[dataSection])) {
        renderGroups(allData[dataSection]);
      } else {
        console.error(`No valid data for section: ${dataSection}`);
        document.getElementById('roster').innerHTML = '<div class="loading">No data available for this section.</div>';
      }
    }

    // Function to fetch all data from Firebase
    async function fetchAllData() {
      document.getElementById('roster').innerHTML = '<div class="loading">Loading roster data...</div>';
      
      try {
        console.log("Fetching roster data...");
        const snapshot = await database.ref('roster').once('value');
        const data = snapshot.val();
        
        console.log("Roster data received:", data);
        
        if (!data) {
          console.warn("No roster data found");
          document.getElementById('roster').innerHTML = '<div class="loading">No roster data found. Please check back later or contact an administrator.</div>';
          return;
        }
        
        // Ensure we have arrays for each section
        allData.normal = Array.isArray(data.normal) ? data.normal : [];
        allData.hard = Array.isArray(data.hard) ? data.hard : [];
        allData.reruns = Array.isArray(data.reruns) ? data.reruns : [];
        
        console.log("Data processed:", allData);
        
        // Update the last fetched time
        const now = new Date();
        document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
        
        // Render the active section (use correct section name mapping)
        const dataSection = currentSection === 'rerun' ? 'reruns' : currentSection;
        renderGroups(allData[dataSection]);
        
        // Set up realtime listener
        database.ref('roster').on('value', (snapshot) => {
          const updatedData = snapshot.val();
          if (!updatedData) return;
          
          console.log("Real-time update received:", updatedData);
          
          allData.normal = Array.isArray(updatedData.normal) ? updatedData.normal : [];
          allData.hard = Array.isArray(updatedData.hard) ? updatedData.hard : [];
          allData.reruns = Array.isArray(updatedData.reruns) ? updatedData.reruns : [];
          
          // Use the correct section mapping when rendering
          const dataSection = currentSection === 'rerun' ? 'reruns' : currentSection;
          renderGroups(allData[dataSection]);
        });
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('roster').innerHTML = `<div class="loading">Error loading roster data: ${error.message}</div>`;
        document.getElementById('lastUpdated').textContent = `Error: ${error.message}`;
      }
    }
    
    // Enables optimized drag and drop with better performance
    function enableDragAndDrop() {
      const lists = document.querySelectorAll('.player-list');
      
      // Add optimized hover effect styles
      const style = document.createElement('style');
      style.textContent = `
        .player-list li.sortable-ghost {
          opacity: 0.5;
          background-color: rgba(61, 132, 247, 0.3) !important;
          transition: all 0.3s ease !important; // ADDED TRANSITION
        }
        .player-list li.sortable-chosen {
          opacity: 0.8;
          transform: scale(1.02);
          transition: all 0.3s ease !important; // ADDED TRANSITION
        }
        .player-list li.highlight-drop {
          background-color: rgba(61, 132, 247, 0.5) !important;
          transition: background-color 0.1s ease;
        }
        .player-list li[draggable="true"] {
          cursor: grab;
          transition: none; /* Remove transitions during drag */
        }
        .player-list li[draggable="true"]:active {
          cursor: grabbing;
        }
      `;
      document.head.appendChild(style);
    
      lists.forEach((list) => {
        new Sortable(list, {
          group: {
            name: 'shared',
            pull: true, // CHANGED FROM 'clone' TO 'true'
            put: true
          },
          animation: 150, // CHANGED FROM 100 TO 150
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen',
          dragClass: 'sortable-drag',
          swap: true,
          swapClass: 'highlight-drop',
          invertSwap: true,
          forceFallback: false,
          fallbackOnBody: true,
          fallbackTolerance: 3,
          delay: 50,
          delayOnTouchOnly: true,
          
          // Optimized event handlers
          onStart: function(evt) {
            evt.item.classList.add('dragging');
          },
          onEnd: function(evt) {
            evt.item.classList.remove('dragging');
            setTimeout(() => saveDragChanges(), 10);
          },
          // REMOVED THE ONADD HANDLER COMPLETELY
        });
      });
    
      // Set up optimized drop targets
      setupPlayerSlotDropTargets();
    }
    
    async function saveDragChanges() {
      const sectionName = currentSection === 'rerun' ? 'reruns' : currentSection;
      const groups = document.querySelectorAll('.group');
      const updates = {};
      
      // First collect all changes
      for (let i = 0; i < groups.length; i++) {
        const listItems = groups[i].querySelectorAll('.player-list li');
        const newPlayers = [];
    
        listItems.forEach(li => {
          if (li.hasAttribute('data-empty-slot')) {
            newPlayers.push('');
            return;
          }
    
          // MODIFIED THIS LINE TO STRIP SYMBOLS PROPERLY
          let rawName = li.dataset.originalName || 
                       (li.querySelector('span') ? 
                        li.querySelector('span').textContent.replace(/^[âœ”âœ¦]\s*/, '').trim() : '');
    
          if (!rawName || rawName === '- empty -') {
            newPlayers.push('');
          } else {
            const symbol = rawName.includes('âœ¦') ? 'âœ¦ ' : 'âœ” ';
            const cleanedName = rawName.replace(/^âœ”\s*|^âœ¦\s*/, '').trim();
            newPlayers.push(symbol + cleanedName);
          }
        });
    
        // Ensure we always have 5 slots
        while (newPlayers.length < 5) {
          newPlayers.push('');
        }
    
        // Store the update
        updates[`roster/${sectionName}/${i}/players`] = newPlayers;
      }
    
      // Perform a single atomic update to Firebase
      try {
        await database.ref().update(updates);
      } catch (error) {
        console.error('Error saving drag changes:', error);
      }
      
      // No need to manually re-render - the Firebase listener will handle it
    }
      
    // Function to load and display all users
    async function loadAllUsers() {
      try {
        const snapshot = await database.ref('users').once('value');
        const users = snapshot.val() || {};
        const userList = document.getElementById('userList');
        
        if (Object.keys(users).length === 0) {
          userList.innerHTML = '<div class="loading">No users found</div>';
          return;
        }
        
        userList.innerHTML = '';
        
        // Convert to array and sort alphabetically
        const userArray = Object.values(users)
          .filter(user => user.username) // Only include users with usernames
          .sort((a, b) => a.username.localeCompare(b.username));
        
        userArray.forEach(user => {
          const userItem = document.createElement('div');
          userItem.className = 'user-list-item';
          
          // Make item draggable only for admins/officers
          if (currentUser && (currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role))) {
            userItem.draggable = true;
            userItem.style.cursor = 'grab';
            userItem.addEventListener('dragstart', handleUserDragStart);
          }
          
          const avatarUrl = user.photoURL || '';
          const roleBadge = getRoleBadgeImage(user.role);
          
          userItem.innerHTML = `
            ${avatarUrl ? `<img src="${avatarUrl}" class="user-list-avatar" alt="${user.username}">` : 
              `<div class="user-list-avatar" style="background-color: ${stringToColor(user.username)}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.username.charAt(0).toUpperCase()}</div>`}
            <span class="user-list-name">${user.username}</span>
            ${roleBadge ? `<img src="${roleBadge}" class="user-list-role" alt="${user.role}" style="width: 24px; height: 24px;">` : ''}
          `;
          
          // Store user data on the element
          userItem.dataset.username = user.username;
          userItem.dataset.role = user.role;
          
          userList.appendChild(userItem);
        });
        
        // Rest of the function remains the same...
        // Set up realtime updates
        database.ref('users').on('value', (snapshot) => {
          const updatedUsers = snapshot.val() || {};
          const updatedList = document.getElementById('userList');
          updatedList.innerHTML = '';
          
          // Update our global user data objects
          window.allUserPhotos = {};
          window.allUserRoles = {};
          window.allUserAdmins = {};
          
          const updatedArray = Object.values(updatedUsers)
            .filter(user => user.username)
            .sort((a, b) => a.username.localeCompare(b.username));
          
          // First update our global user data
          updatedArray.forEach(user => {
            if (user.username) {
              if (user.photoURL) {
                window.allUserPhotos[user.username] = user.photoURL;
              }
              window.allUserRoles[user.username] = user.role;
              window.allUserAdmins[user.username] = user.isAdmin || false;
            }
          });
          
          // Then render the user list
          updatedArray.forEach(user => {
            const userItem = document.createElement('div');
            userItem.className = 'user-list-item';
            
            // Make item draggable only for admins/officers
            if (currentUser && (currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role))) {
              userItem.draggable = true;
              userItem.style.cursor = 'grab';
              userItem.addEventListener('dragstart', handleUserDragStart);
            }
            
            const avatarUrl = user.photoURL || '';
            // Update to use the new getRoleBadgeImage that checks isAdmin
            const roleBadge = getRoleBadgeImage({ 
              role: user.role, 
              isAdmin: user.isAdmin || false 
            });
            
            userItem.innerHTML = `
              ${avatarUrl ? `<img src="${avatarUrl}" class="user-list-avatar" alt="${user.username}">` : 
                `<div class="user-list-avatar" style="background-color: ${stringToColor(user.username)}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.username.charAt(0).toUpperCase()}</div>`}
              <span class="user-list-name">${user.username}</span>
              ${roleBadge ? `<img src="${roleBadge}" class="user-list-role" alt="${user.isAdmin ? 'admin' : user.role}" style="width: 24px; height: 24px;">` : ''}
            `;
            
            // Store user data on the element
            userItem.dataset.username = user.username;
            userItem.dataset.role = user.role;
            userItem.dataset.isAdmin = user.isAdmin || false;
            
            updatedList.appendChild(userItem);
          });
        });
        
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('userList').innerHTML = `<div class="loading">Error loading users: ${error.message}</div>`;
      }
    }

    // Optimized drag start from user list handler
    function handleUserDragStart(e) {
      const listItem = e.target.closest('.user-list-item');
      if (!listItem) return;
    
      const username = listItem.dataset.username || 
                     listItem.textContent.replace(/^[âœ”âœ¦]\s*/, '').trim();
    
      const role = listItem.dataset.role || 
                  (listItem.textContent.includes('âœ¦') ? 'mercenary' : 'member');
    
      // Set both text and JSON data
      e.dataTransfer.setData('text/plain', username);
      e.dataTransfer.setData('application/json', JSON.stringify({
        username: username,
        role: role
      }));
      
      // Set the allowed effect
      e.dataTransfer.effectAllowed = 'copyMove';
    
      // Create a simple drag image
      const dragImage = document.createElement('div');
      dragImage.textContent = username;
      dragImage.style.position = 'fixed';
      dragImage.style.left = '-9999px';
      dragImage.style.padding = '4px 8px';
      dragImage.style.background = 'var(--bg-secondary)';
      dragImage.style.border = '1px solid var(--border-light)';
      dragImage.style.borderRadius = '4px';
      document.body.appendChild(dragImage);
      e.dataTransfer.setDragImage(dragImage, 0, 0);
      
      // Clean up
      setTimeout(() => document.body.removeChild(dragImage), 0);
    }
    
    // Set up optimized drop targets on player slots
    function setupPlayerSlotDropTargets() {
      const playerSlots = document.querySelectorAll('.player-list li');
      
      playerSlots.forEach(slot => {
        if (currentUser && (currentUser.isAdmin || ['guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role))) {
          // Remove any existing listeners
          slot.removeEventListener('dragover', handleSlotDragOver);
          slot.removeEventListener('dragenter', handleSlotDragEnter);
          slot.removeEventListener('dragleave', handleSlotDragLeave);
          slot.removeEventListener('drop', handleSlotDrop);
          slot.removeEventListener('dragend', handleSlotDragEnd);
          
          // Add optimized listeners
          slot.addEventListener('dragover', handleSlotDragOver);
          slot.addEventListener('dragenter', handleSlotDragEnter);
          slot.addEventListener('dragleave', handleSlotDragLeave);
          slot.addEventListener('drop', handleSlotDrop);
          slot.addEventListener('dragend', handleSlotDragEnd);
          
          // Ensure the slot is a valid drop target
          slot.setAttribute('droppable', 'true');
        }
      });
    }
    
    // Optimized event handlers
    function handleSlotDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }
    
    function handleSlotDragEnter(e) {
      e.preventDefault();
      // Use immediate update without requestAnimationFrame for dragenter
      e.target.classList.add('highlight-drop');
    }
    
    function handleSlotDragLeave(e) {
      // Don't preventDefault on passive events
      // Use immediate update without requestAnimationFrame for dragleave
      e.target.classList.remove('highlight-drop');
    }
    
    function handleSlotDragEnd(e) {
      // Don't preventDefault on passive events
      // Clear all highlights immediately
      document.querySelectorAll('.player-list li').forEach(slot => {
        slot.classList.remove('highlight-drop');
      });
    }
    
    async function handleSlotDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Clear highlight immediately
      e.target.classList.remove('highlight-drop');
      
      try {
        // Try to get JSON data first, then fall back to text
        let data;
        try {
          const jsonData = e.dataTransfer.getData('application/json');
          data = jsonData ? JSON.parse(jsonData) : null;
        } catch (error) {
          const textData = e.dataTransfer.getData('text/plain');
          data = textData ? { username: textData, role: 'member' } : null;
        }
    
        if (!data || !data.username) return;
    
        const groupElement = e.target.closest('.group');
        if (!groupElement) return;
        
        const groupIndex = Array.from(document.querySelectorAll('.group')).indexOf(groupElement);
        const slotIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
    
        const symbol = data.role === 'mercenary' ? 'âœ¦ ' : 'âœ” ';
        const playerName = symbol + data.username;
    
        const sectionName = currentSection === 'rerun' ? 'reruns' : currentSection;
        
        // Update the data immediately for responsive UI
        allData[sectionName][groupIndex].players[slotIndex] = playerName;
        
        // Save to Firebase
        await database.ref(`roster/${sectionName}`).set(allData[sectionName]);
        
        // Render immediately for better UX
        renderGroups(allData[sectionName]);
      } catch (error) {
        console.debug('Drag operation completed', error);
      }
    }
    
    // Helper function to generate a color from a string
    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      let color = '#';
      for (let i = 0; i < 3; i++) {
        const value = (hash >> (i * 8)) & 0xFF;
        color += ('00' + value.toString(16)).substr(-2);
      }
      return color;
    }

    function updateDropdownAvatar() {
      const dropdownAvatar = document.getElementById('dropdown-avatar');
      if (!dropdownAvatar || !currentUser) return;
    
      const color = stringToColor(currentUser.username);
      const initial = currentUser.username.charAt(0).toUpperCase();
    
      if (currentUser.photoURL) {
        dropdownAvatar.innerHTML = `
          <img src="${currentUser.photoURL}" 
               alt="${currentUser.username}'s avatar"
               style="display:block;width:100%;height:100%;object-fit:cover;margin:0">
        `;
      } else {
        dropdownAvatar.innerHTML = `
          <div class="default-avatar" 
               style="background:${color};color:white;margin:0">
            ${initial}
          </div>
        `;
      }
    }

    // Sidebar toggle functionality
    document.addEventListener('DOMContentLoaded', function() {
      const sidebar = document.getElementById('userSidebar');
      const toggleButton = document.getElementById('sidebarToggle');
      
      // Check if sidebar state is saved in localStorage
      const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      if (isCollapsed) {
        sidebar.classList.add('collapsed');
      }
      
      toggleButton.addEventListener('click', function() {
        sidebar.classList.toggle('collapsed');
        // Save state to localStorage
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
      });
    });
    
    // Check for modal trigger on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('openAdminModal')) {
        localStorage.removeItem('openAdminModal');
        openModal('adminModal');
        // Optional: Reset URL if needed
        history.replaceState(null, null, ' ');
      }
    });
      
    // Initial load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>